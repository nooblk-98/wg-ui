version: "3.8"
volumes:
  etc_wireguard:

networks:
  proxy-net:
    external: true

configs:
  authelia_config:
    file: ./authelia-conf.yml

services:

  nginx:
    image: "jc21/nginx-proxy-manager:latest"
    container_name: "nginx"
    restart: unless-stopped
    networks:
      - proxy-net
    ports:
      - 80:80
      - 81:81
      - 443:443
    volumes:
      - ${HOME}/docker-data/nginx/data:/data:rw
      - ${HOME}/docker-data/nginx/letsencrypt:/etc/letsencrypt:rw
      - ./authelia_snippets:/snippets:ro


  wg-easy:
    environment:
      - LANG=en
      - WG_HOST=raspberrypi.local
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wg-easy
    volumes:
      - etc_wireguard:/etc/wireguard
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1

  authelia:
    container_name: "authelia"
    image: "authelia/authelia:latest"
    restart: unless-stopped
    networks:
      - proxy-net
    expose:
      - 9091
    configs:
      - source: authelia_config
        target: /config/configuration.yml
    env_file:
      - auth.env
    volumes:
      - ${HOME}/docker-data/auth/authelia/data:/data:rw
      - ${HOME}/docker-data/auth/authelia/config:/config:rw

  lldap:
    container_name: "lldap"
    image: "nitnelave/lldap:latest"
    restart: unless-stopped
    networks:
      - proxy-net
    expose:
      - 3890 # LDAP service
      - 17170 # Web service
    env_file:
      - auth.env
    environment:
      UID: 0
    volumes:
      - ${HOME}/docker-data/auth/lldap:/data:rw